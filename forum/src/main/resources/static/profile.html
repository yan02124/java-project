<!-- 个人主页 - 优化版 -->
<style>
  /* 个人主页头部 */
  .profile-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    padding: 25px 0 50px;
    color: white;
    position: relative;
  }
  .profile-header::after {
    content: '';
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    height: 25px;
    background: #f5f7fb;
    border-radius: 25px 25px 0 0;
  }
  
  /* 用户信息卡片 */
  .profile-user-card {
    background: white;
    border-radius: 12px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.08);
    padding: 20px;
    margin-top: -35px;
    position: relative;
    z-index: 10;
    text-align: center;
  }
  .profile-avatar-wrapper {
    text-align: center;
    margin-bottom: 12px;
  }
  .profile-avatar {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    border: 3px solid white;
    box-shadow: 0 3px 12px rgba(0,0,0,0.12);
  }
  .profile-name {
    font-size: 1.1rem;
    font-weight: 600;
    color: #333;
    margin-bottom: 6px;
    text-align: center;
  }
  .profile-role {
    text-align: center;
    margin-bottom: 15px;
  }
  .profile-role .badge {
    padding: 4px 12px;
    font-size: 0.75rem;
    border-radius: 12px;
  }
  
  /* 统计数据 */
  .profile-stats {
    display: flex;
    justify-content: center;
    gap: 30px;
    padding: 12px 0;
    border-top: 1px solid #f0f0f0;
    border-bottom: 1px solid #f0f0f0;
    margin: 12px 0;
  }
  .stat-item {
    text-align: center;
  }
  .stat-num {
    font-size: 1.2rem;
    font-weight: 600;
    color: #667eea;
  }
  .stat-label {
    font-size: 0.75rem;
    color: #999;
    margin-top: 2px;
  }
  
  /* 用户信息列表 */
  .profile-info-list {
    margin-top: 12px;
  }
  .info-item {
    display: flex;
    align-items: center;
    padding: 8px 0;
    border-bottom: 1px solid #f8f8f8;
  }
  .info-item:last-child {
    border-bottom: none;
  }
  .info-icon {
    width: 32px;
    height: 32px;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 10px;
    flex-shrink: 0;
  }
  .info-icon svg {
    width: 16px;
    height: 16px;
  }
  .info-icon.email { background: #e3f2fd; color: #1976d2; }
  .info-icon.date { background: #e8f5e9; color: #388e3c; }
  .info-label {
    font-size: 0.75rem;
    color: #999;
  }
  .info-value {
    font-size: 0.85rem;
    color: #333;
    margin-top: 1px;
  }
  
  /* 个人简介 */
  .profile-bio {
    background: #f8f9fb;
    border-radius: 8px;
    padding: 12px;
    margin-top: 12px;
  }
  .profile-bio-title {
    font-size: 0.8rem;
    color: #666;
    margin-bottom: 6px;
    display: flex;
    align-items: center;
    gap: 6px;
  }
  .profile-bio-title svg {
    width: 14px;
    height: 14px;
  }
  .profile-bio-content {
    color: #666;
    line-height: 1.5;
    font-size: 0.8rem;
  }
  
  /* 内容区域 */
  .profile-content {
    background: #f5f7fb;
    padding: 20px 0 40px;
  }
  
  /* 帖子列表卡片 */
  .posts-card {
    background: white;
    border-radius: 12px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.06);
    overflow: hidden;
  }
  .posts-header {
    padding: 12px 16px;
    border-bottom: 1px solid #f0f0f0;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .posts-header svg {
    width: 16px;
    height: 16px;
  }
  .posts-header h3 {
    margin: 0;
    font-size: 0.9rem;
    font-weight: 600;
    color: #333;
  }
  .posts-count {
    background: #667eea;
    color: white;
    padding: 1px 8px;
    border-radius: 10px;
    font-size: 0.7rem;
  }
  
  /* 帖子项 - 紧凑样式 */
  .post-item {
    padding: 12px 16px;
    border-bottom: 1px solid #f5f5f5;
    transition: all 0.2s;
    cursor: pointer;
  }
  .post-item:last-child {
    border-bottom: none;
  }
  .post-item:hover {
    background: #fafbff;
  }
  .post-title {
    font-size: 0.9rem;
    font-weight: 500;
    color: #333;
    margin-bottom: 6px;
    transition: color 0.2s;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }
  .post-title:hover {
    color: #667eea;
  }
  .post-meta {
    display: flex;
    flex-wrap: wrap;
    gap: 12px;
    align-items: center;
  }
  .post-time {
    display: flex;
    align-items: center;
    gap: 4px;
    color: #aaa;
    font-size: 0.75rem;
  }
  .post-time svg {
    width: 12px;
    height: 12px;
  }
  .post-stats {
    display: flex;
    gap: 10px;
    margin-left: auto;
  }
  .post-stat {
    display: flex;
    align-items: center;
    gap: 3px;
    color: #aaa;
    font-size: 0.75rem;
  }
  .post-stat svg {
    width: 12px;
    height: 12px;
  }
  
  /* 空状态 */
  .empty-posts {
    text-align: center;
    padding: 40px 20px;
    color: #bbb;
  }
  .empty-posts svg {
    width: 50px;
    height: 50px;
    margin-bottom: 12px;
    opacity: 0.4;
  }
  .empty-posts p {
    font-size: 0.85rem;
    margin: 0;
  }
  
  /* 发私信按钮 */
  .btn-message {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    padding: 8px 20px;
    border-radius: 20px;
    font-weight: 500;
    font-size: 0.85rem;
    transition: all 0.3s;
    width: 100%;
    margin-top: 12px;
  }
  .btn-message:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 15px rgba(102,126,234,0.35);
    color: white;
  }
  .btn-message svg {
    width: 16px;
    height: 16px;
  }
</style>

<input type="hidden" id="profile_user_id">

<!-- 头部背景 -->
<div class="profile-header">
  <div class="container-xl">
    <h2 class="text-white text-center mb-0" style="opacity: 0.9; font-size: 1.2rem;">个人主页</h2>
  </div>
</div>

<!-- 主内容区 -->
<div class="profile-content">
  <div class="container-xl">
    <div class="row g-4">
      <!-- 左侧用户信息 -->
      <div class="col-lg-4">
        <div class="profile-user-card">
          <div class="profile-avatar-wrapper">
            <span id="profile_avatar" class="avatar profile-avatar" style="background-image: url(./image/avatar01.jpeg)"></span>
          </div>
          <h2 class="profile-name" id="profile_nickname"></h2>
          <div class="profile-role">
            <span class="badge bg-primary" id="profile_role_badge">用户</span>
          </div>
          
          <div class="profile-stats">
            <div class="stat-item">
              <div class="stat-num" id="profile_articleCount">0</div>
              <div class="stat-label">发帖数</div>
            </div>
            <div class="stat-item">
              <div class="stat-num" id="profile_likeCount">0</div>
              <div class="stat-label">获赞数</div>
            </div>
          </div>
          
          <div class="profile-info-list">
            <div class="info-item">
              <div class="info-icon email">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path>
                  <polyline points="22,6 12,13 2,6"></polyline>
                </svg>
              </div>
              <div>
                <div class="info-label">邮箱</div>
                <div class="info-value" id="profile_email">未设置</div>
              </div>
            </div>
            <div class="info-item">
              <div class="info-icon date">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                  <line x1="16" y1="2" x2="16" y2="6"></line>
                  <line x1="8" y1="2" x2="8" y2="6"></line>
                  <line x1="3" y1="10" x2="21" y2="10"></line>
                </svg>
              </div>
              <div>
                <div class="info-label">注册时间</div>
                <div class="info-value" id="profile_createTime">-</div>
              </div>
            </div>
          </div>
          
          <div class="profile-bio">
            <div class="profile-bio-title">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                <circle cx="12" cy="7" r="4"></circle>
              </svg>
              个人简介
            </div>
            <div class="profile-bio-content" id="profile_remark">这家伙很懒，什么也没有留下...</div>
          </div>
          
          <div id="div_profile_send_message" style="display: none;">
            <a href="javascript:void(0);" class="btn btn-message" id="btn_profile_send_message">
              <svg xmlns="http://www.w3.org/2000/svg" class="icon me-2" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
              </svg>
              发送私信
            </a>
          </div>
        </div>
      </div>
      
      <!-- 右侧帖子列表 -->
      <div class="col-lg-8">
        <div class="posts-card">
          <div class="posts-header">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="#667eea" stroke-width="2">
              <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
              <polyline points="14 2 14 8 20 8"></polyline>
              <line x1="16" y1="13" x2="8" y2="13"></line>
              <line x1="16" y1="17" x2="8" y2="17"></line>
              <polyline points="10 9 9 9 8 9"></polyline>
            </svg>
            <h3>TA的帖子</h3>
            <span class="posts-count" id="posts_count_badge">0</span>
          </div>
          <div id="profile_article_body">
            <!-- 动态构建帖子列表 -->
          </div>
        </div>
      </div>
    </div>
  </div>
</div>


<script>
  // 获取用户ID（优先从全局变量获取，其次从URL参数获取）
  function getUserId() {
    // 先检查全局变量 profileUserId
    if (typeof profileUserId !== 'undefined' && profileUserId) {
      return profileUserId;
    }
    // 再检查URL参数
    const params = new URLSearchParams(window.location.search);
    const urlId = params.get('id');
    if (urlId) {
      return urlId;
    }
    // 最后尝试获取当前登录用户ID
    return null;
  }
  
  // 页面加载完成后初始化
  $(function() {
    let userId = getUserId();
    
    // 如果没有指定用户ID，尝试获取当前登录用户
    if (!userId) {
      $.ajax({
        type: 'GET',
        url: '/user/info',
        async: false,
        success: function(respData) {
          if (respData.code == 0 && respData.data) {
            userId = respData.data.id;
          }
        }
      });
    }
    
    if (!userId) {
      $.toast({
        heading: '错误',
        text: '用户ID不存在',
        icon: 'error'
      });
      return;
    }
    
    // 设置隐藏字段
    $('#profile_user_id').val(userId);
    
    // 获取用户信息
    getUserInfo(userId);
    
    // 获取用户帖子列表
    getUserArticles(userId);
    
    // 判断是否显示发私信按钮
    checkShowMessageBtn(userId);
  });
  
  // 获取用户信息
  function getUserInfo(userId) {
    $.ajax({
      type: 'GET',
      url: '/user/info?id=' + userId,
      success: function(respData) {
        if (respData.code == 0 && respData.data) {
          const user = respData.data;
          
          // 设置头像
          if (user.avatarUrl) {
            $('#profile_avatar').css('background-image', 'url(' + user.avatarUrl + ')');
          }
          
          // 设置昵称
          $('#profile_nickname').text(user.nickname || '未设置昵称');
          
          // 设置角色标签
          if (user.isAdmin == 1) {
            $('#profile_role_badge').removeClass('bg-primary').addClass('bg-danger').text('管理员');
          } else {
            $('#profile_role_badge').text('普通用户');
          }
          
          // 设置统计数据
          $('#profile_articleCount').text(user.articleCount || 0);
          $('#profile_likeCount').text(user.likeCount || 0);
          
          // 设置邮箱
          if (user.email) {
            $('#profile_email').text(user.email);
          }
          
          // 设置注册时间
          if (user.createTime) {
            const date = new Date(user.createTime);
            $('#profile_createTime').text(date.toLocaleDateString('zh-CN'));
          }
          
          // 设置个人简介
          if (user.remark) {
            $('#profile_remark').text(user.remark);
          }
        }
      },
      error: function() {
        $.toast({
          heading: '错误',
          text: '获取用户信息失败',
          icon: 'error'
        });
      }
    });
  }
  
  // 获取用户帖子列表
  function getUserArticles(userId) {
    $.ajax({
      type: 'GET',
      url: '/article/getAllByUserId?userId=' + userId,
      success: function(respData) {
        if (respData.code == 0) {
          const articles = respData.data || [];
          buildProfileArticleList(articles);
          $('#posts_count_badge').text(articles.length);
        }
      },
      error: function() {
        $.toast({
          heading: '错误',
          text: '获取帖子列表失败',
          icon: 'error'
        });
      }
    });
  }
  
  // 构建帖子列表（使用不同的函数名避免与全局函数冲突）
  function buildProfileArticleList(articles) {
    const container = $('#profile_article_body');
    container.empty();
    
    if (!articles || articles.length === 0) {
      container.html(`
        <div class="empty-posts">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
            <polyline points="14 2 14 8 20 8"></polyline>
          </svg>
          <p>暂无发布的帖子</p>
        </div>
      `);
      return;
    }
    
    articles.forEach(function(article) {
      const createTime = article.createTime ? new Date(article.createTime).toLocaleDateString('zh-CN') : '-';
      
      const html = `
        <div class="post-item" data-article-id="${article.id}" style="cursor: pointer;">
          <div class="post-title">${escapeHtml(article.title)}</div>
          <div class="post-meta">
            <div class="post-time">
              <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"></circle>
                <polyline points="12 6 12 12 16 14"></polyline>
              </svg>
              ${createTime}
            </div>
            <div class="post-stats">
              <span class="post-stat">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                  <circle cx="12" cy="12" r="3"></circle>
                </svg>
                ${article.visitCount || 0}
              </span>
              <span class="post-stat">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M14 9V5a3 3 0 0 0-3-3l-4 9v11h11.28a2 2 0 0 0 2-1.7l1.38-9a2 2 0 0 0-2-2.3zM7 22H4a2 2 0 0 1-2-2v-7a2 2 0 0 1 2-2h3"></path>
                </svg>
                ${article.likeCount || 0}
              </span>
              <span class="post-stat">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                </svg>
                ${article.replyCount || 0}
              </span>
            </div>
          </div>
        </div>
      `;
      const postItem = $(html);
      // 添加点击事件，通过AJAX加载详情页
      postItem.click(function() {
        currentArticle = { id: article.id };
        removeNavActive();
        $('#bit-forum-content').load('details.html', function() {
          $('html, body').animate({ scrollTop: 0 }, 300);
        });
      });
      container.append(postItem);
    });
  }
  
  // 检查是否显示发私信按钮
  function checkShowMessageBtn(profileUserId) {
    // 获取当前登录用户
    $.ajax({
      type: 'GET',
      url: '/user/info',
      success: function(respData) {
        if (respData.code == 0 && respData.data) {
          const currentUser = respData.data;
          // 如果不是查看自己的主页，显示发私信按钮
          if (currentUser.id != profileUserId) {
            $('#div_profile_send_message').show();
            // 设置私信接收者ID
            $('#btn_profile_send_message').click(function() {
              $('#index_message_receiveUserId').val(profileUserId);
            });
          }
        }
      }
    });
  }
  
  // HTML转义函数
  function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }
</script>
