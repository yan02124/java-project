<meta charset="UTF-8">
<!-- 帖子详情页面 - 优化版 -->
<style>
  /* 详情页整体样式 */
  .detail-page {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    min-height: 100vh;
    padding-bottom: 30px;
  }
  
  /* 帖子头部区域 */
  .article-header {
    background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
    padding: 20px 0 35px;
    color: white;
    position: relative;
  }
  .article-header::after {
    content: '';
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    height: 20px;
    background: #f5f7fb;
    border-radius: 20px 20px 0 0;
  }
  .article-title {
    font-size: 1.3rem;
    font-weight: 600;
    margin-bottom: 12px;
  }
  .article-meta {
    display: flex;
    flex-wrap: wrap;
    gap: 12px;
    align-items: center;
  }
  .meta-item {
    display: flex;
    align-items: center;
    gap: 4px;
    font-size: 0.8rem;
    opacity: 0.9;
  }
  .meta-item svg {
    width: 14px;
    height: 14px;
  }
  
  /* 主内容区域 */
  .detail-content-area {
    background: #f5f7fb;
    padding: 0 0 30px;
    margin-top: -20px;
  }
  
  /* 作者卡片 */
  .author-card {
    background: white;
    border-radius: 12px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.08);
    padding: 20px 15px;
    text-align: center;
    position: sticky;
    top: 15px;
  }
  .author-avatar {
    width: 70px;
    height: 70px;
    border-radius: 50%;
    border: 3px solid #667eea;
    margin-bottom: 10px;
    box-shadow: 0 3px 10px rgba(102,126,234,0.25);
  }
  .author-name {
    font-size: 1rem;
    font-weight: 600;
    color: #333;
    margin-bottom: 6px;
    cursor: pointer;
  }
  .author-name:hover {
    color: #667eea;
  }
  .author-badge {
    display: inline-block;
    padding: 3px 10px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 12px;
    font-size: 0.7rem;
    margin-bottom: 12px;
  }
  .author-stats {
    display: flex;
    justify-content: center;
    gap: 20px;
    margin: 12px 0;
    padding: 12px 0;
    border-top: 1px solid #f0f0f0;
    border-bottom: 1px solid #f0f0f0;
  }
  .author-stat-item {
    text-align: center;
  }
  .author-stat-num {
    font-size: 1.1rem;
    font-weight: 600;
    color: #667eea;
  }
  .author-stat-label {
    font-size: 0.7rem;
    color: #999;
  }
  
  /* 文章内容卡片 */
  .article-card {
    background: white;
    border-radius: 12px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.08);
    overflow: hidden;
  }
  .article-content-header {
    padding: 15px 20px;
    border-bottom: 1px solid #f0f0f0;
    background: linear-gradient(to right, #fafbfc, #ffffff);
  }
  .article-content-title {
    font-size: 1.1rem;
    font-weight: 600;
    color: #333;
    margin: 0;
  }
  .article-body {
    padding: 20px;
    min-height: 150px;
    line-height: 1.7;
    font-size: 0.9rem;
    color: #444;
  }
  .article-body img {
    max-width: 100%;
    border-radius: 6px;
  }
  .article-body pre {
    background: #f8f9fa;
    border-radius: 6px;
    padding: 12px;
    font-size: 0.85rem;
  }
  
  /* 操作按钮区 */
  .action-bar {
    padding: 12px 20px;
    background: #fafbfc;
    border-top: 1px solid #f0f0f0;
    display: flex;
    justify-content: flex-end;
    gap: 8px;
    flex-wrap: wrap;
  }
  .action-btn {
    padding: 6px 14px;
    border-radius: 16px;
    font-weight: 500;
    font-size: 0.8rem;
    display: flex;
    align-items: center;
    gap: 4px;
    transition: all 0.2s;
  }
  .action-btn svg {
    width: 14px;
    height: 14px;
  }
  .action-btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 3px 10px rgba(0,0,0,0.12);
  }
  .like-btn {
    background: linear-gradient(135deg, #ff6b6b 0%, #ee5a5a 100%);
    color: white;
    border: none;
  }
  .like-btn:hover {
    background: linear-gradient(135deg, #ff5252 0%, #e53935 100%);
    color: white;
  }
  
  /* AI区域 */
  .ai-section {
    background: white;
    border-radius: 12px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.08);
    margin-top: 15px;
    overflow: hidden;
  }
  .ai-header {
    padding: 10px 16px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 0.9rem;
  }
  .ai-header svg {
    width: 16px;
    height: 16px;
  }
  .ai-body {
    padding: 16px;
    line-height: 1.7;
    font-size: 0.85rem;
  }
  
  /* 回复区域 */
  .reply-section {
    margin-top: 20px;
  }
  .reply-section-title {
    font-size: 1rem;
    font-weight: 600;
    color: #333;
    margin-bottom: 12px;
    padding-left: 10px;
    border-left: 3px solid #667eea;
  }
  .reply-card {
    background: white;
    border-radius: 12px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.08);
    margin-bottom: 15px;
    overflow: hidden;
  }
  .reply-item {
    display: flex;
    padding: 12px 16px;
    border-bottom: 1px solid #f5f5f5;
  }
  .reply-item:last-child {
    border-bottom: none;
  }
  .reply-author {
    width: 60px;
    text-align: center;
    flex-shrink: 0;
  }
  .reply-avatar {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    margin-bottom: 4px;
  }
  .reply-author-name {
    font-size: 0.75rem;
    color: #667eea;
    font-weight: 500;
  }
  .reply-content-area {
    flex: 1;
    padding-left: 12px;
    border-left: 1px solid #f0f0f0;
    margin-left: 10px;
  }
  .reply-content {
    line-height: 1.6;
    color: #444;
    font-size: 0.85rem;
  }
  .reply-time {
    font-size: 0.7rem;
    color: #aaa;
    margin-top: 6px;
  }
  .empty-reply {
    text-align: center;
    padding: 30px;
    color: #bbb;
  }
  .empty-reply svg {
    width: 40px;
    height: 40px;
    margin-bottom: 10px;
    opacity: 0.4;
  }
  .empty-reply p {
    font-size: 0.85rem;
    margin: 0;
  }
  
  /* 回复编辑区 */
  .reply-editor-card {
    background: white;
    border-radius: 12px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.08);
    overflow: hidden;
  }
  .reply-editor-header {
    padding: 10px 16px;
    background: #fafbfc;
    border-bottom: 1px solid #f0f0f0;
    font-weight: 600;
    font-size: 0.9rem;
    color: #333;
  }
  .reply-editor-body {
    padding: 12px 16px;
  }
  .reply-editor-body .editormd {
    border: 1px solid #e0e0e0;
    border-radius: 8px;
  }
  .reply-editor-body .editormd-toolbar {
    background: #fafbfc;
    border-bottom: 1px solid #e0e0e0;
    border-radius: 8px 8px 0 0;
    padding: 5px;
  }
  .reply-editor-body .CodeMirror {
    min-height: 200px;
    border-radius: 0 0 8px 8px;
  }
  .reply-editor-footer {
    padding: 10px 16px;
    background: #fafbfc;
    border-top: 1px solid #f0f0f0;
    display: flex;
    justify-content: flex-end;
  }
  
  /* 发私信按钮 */
  .btn-message {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 16px;
    font-weight: 500;
    font-size: 0.8rem;
    transition: all 0.2s;
    width: 100%;
    margin-top: 10px;
  }
  .btn-message:hover {
    transform: translateY(-1px);
    box-shadow: 0 3px 12px rgba(102,126,234,0.35);
    color: white;
  }
  .btn-message svg {
    width: 14px;
    height: 14px;
  }
</style>

<!-- 帖子Id（隐藏） -->
<input type="hidden" id="details_article_id">

<!-- 帖子头部区域 -->
<div class="article-header">
  <div class="container-xl">
    <h1 class="article-title" id="details_article_title"></h1>
    <div class="article-meta">
      <div class="meta-item">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="10"></circle>
          <polyline points="12 6 12 12 16 14"></polyline>
        </svg>
        <span id="details_article_createTime"></span>
      </div>
      <div class="meta-item">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
          <circle cx="12" cy="12" r="3"></circle>
        </svg>
        <span><span id="details_article_visitCount">0</span> 浏览</span>
      </div>
      <div class="meta-item">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
        </svg>
        <span><span id="details_article_likeCount">0</span> 点赞</span>
      </div>
      <div class="meta-item">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
        </svg>
        <span><span id="details_article_replyCount">0</span> 回复</span>
      </div>
    </div>
  </div>
</div>

<!-- 主内容区域 -->
<div class="detail-content-area">
  <div class="container-xl">
    <div class="row g-4">
      <!-- 左侧作者信息 -->
      <div class="col-lg-3">
        <div class="author-card">
          <span class="avatar avatar-xl author-avatar" style="background-image: url(./image/avatar01.jpeg)" id="article_details_author_avatar"></span>
          <div class="author-name" id="article_details_author_name"></div>
          <div class="author-badge">作者</div>
          <div class="author-stats">
            <div class="author-stat-item">
              <div class="author-stat-num" id="author_article_count">0</div>
              <div class="author-stat-label">浏览</div>
            </div>
            <div class="author-stat-item">
              <div class="author-stat-num" id="author_like_count">0</div>
              <div class="author-stat-label">获赞</div>
            </div>
          </div>
          <div id="div_details_send_message">
            <a href="javascript:void(0);" class="btn btn-primary w-100" id="btn_details_send_message">
              <svg xmlns="http://www.w3.org/2000/svg" class="icon me-1" width="20" height="20" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none">
                <path d="M3 7a2 2 0 0 1 2 -2h14a2 2 0 0 1 2 2v10a2 2 0 0 1 -2 2h-14a2 2 0 0 1 -2 -2v-10z"></path>
                <path d="M3 7l9 6l9 -6"></path>
              </svg>
              发私信
            </a>
          </div>
        </div>
      </div>
      
      <!-- 右侧文章内容 -->
      <div class="col-lg-9">
        <!-- 文章卡片 -->
        <div class="article-card">
          <div class="article-content-header">
            <h2 class="article-content-title" id="details_article_content_title"></h2>
          </div>
          <div class="article-body" id="details_article_content">
            <!-- 文章内容 -->
          </div>
          <div class="action-bar">
            <a href="javascript:void(0);" class="btn like-btn action-btn" id="details_btn_like_count">
              <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="20" height="20" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none">
                <path d="M19.5 12.572l-7.5 7.428l-7.5 -7.428a5 5 0 1 1 7.5 -6.566a5 5 0 1 1 7.5 6.572"></path>
              </svg>
              点赞
            </a>
            <a href="javascript:void(0);" class="btn btn-info action-btn" id="details_btn_ai_reply">
              <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="20" height="20" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none">
                <path d="M6 4m0 2a2 2 0 0 1 2 -2h8a2 2 0 0 1 2 2v4a2 2 0 0 1 -2 2h-8a2 2 0 0 1 -2 -2z"></path>
                <path d="M12 2v2"></path><path d="M9 12v9"></path><path d="M15 12v9"></path>
                <path d="M5 16l4 -2"></path><path d="M15 14l4 2"></path><path d="M9 18h6"></path>
                <path d="M10 8v.01"></path><path d="M14 8v.01"></path>
              </svg>
              AI回答
            </a>
            <a href="javascript:void(0);" class="btn btn-secondary action-btn" id="details_btn_ai_summary">
              <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="20" height="20" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none">
                <path d="M14 3v4a1 1 0 0 0 1 1h4"></path>
                <path d="M17 21h-10a2 2 0 0 1 -2 -2v-14a2 2 0 0 1 2 -2h7l5 5v11a2 2 0 0 1 -2 2z"></path>
                <path d="M9 9l1 0"></path><path d="M9 13l6 0"></path><path d="M9 17l6 0"></path>
              </svg>
              AI摘要
            </a>
            <a href="javascript:void(0);" class="btn btn-outline-primary action-btn details-is-own" style="display: none;" id="details_artile_edit">
              <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="20" height="20" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none">
                <path d="M7 7h-1a2 2 0 0 0 -2 2v9a2 2 0 0 0 2 2h9a2 2 0 0 0 2 -2v-1"></path>
                <path d="M20.385 6.585a2.1 2.1 0 0 0 -2.97 -2.97l-8.415 8.385v3h3l8.385 -8.415z"></path>
                <path d="M16 5l3 3"></path>
              </svg>
              编辑
            </a>
            <a href="javascript:void(0);" class="btn btn-outline-danger action-btn details-is-own" style="display: none;" data-bs-toggle="modal" data-bs-target="#details_delete_modal">
              <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="20" height="20" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none">
                <path d="M4 7l16 0"></path><path d="M10 11l0 6"></path><path d="M14 11l0 6"></path>
                <path d="M5 7l1 12a2 2 0 0 0 2 2h8a2 2 0 0 0 2 -2l1 -12"></path>
                <path d="M9 7v-3a1 1 0 0 1 1 -1h4a1 1 0 0 1 1 1v3"></path>
              </svg>
              删除
            </a>
          </div>
        </div>
        
        <!-- AI回复区域 -->
        <div class="ai-section" id="ai_reply_area" style="display: none;">
          <div class="ai-header">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none">
              <path d="M6 4m0 2a2 2 0 0 1 2 -2h8a2 2 0 0 1 2 2v4a2 2 0 0 1 -2 2h-8a2 2 0 0 1 -2 -2z"></path>
              <path d="M12 2v2"></path><path d="M9 12v9"></path><path d="M15 12v9"></path>
            </svg>
            <span>AI助手回复</span>
          </div>
          <div class="ai-body" id="ai_reply_content"></div>
        </div>
        
        <!-- AI摘要区域 -->
        <div class="ai-section" id="ai_summary_area" style="display: none;">
          <div class="ai-header">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none">
              <path d="M14 3v4a1 1 0 0 0 1 1h4"></path>
              <path d="M17 21h-10a2 2 0 0 1 -2 -2v-14a2 2 0 0 1 2 -2h7l5 5v11a2 2 0 0 1 -2 2z"></path>
            </svg>
            <span>AI内容摘要</span>
          </div>
          <div class="ai-body" id="ai_summary_content"></div>
        </div>
        
        <!-- 回复区域 -->
        <div class="reply-section">
          <h3 class="reply-section-title">最新回复</h3>
          <div class="reply-card">
            <div id="details_reply_area">
              <!-- 回复列表 -->
            </div>
          </div>
        </div>
        
        <!-- 回复编辑区 -->
        <div class="reply-editor-card">
          <div class="reply-editor-header">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon me-2" width="20" height="20" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none">
              <path d="M8 9h8"></path><path d="M8 13h6"></path>
              <path d="M18 4a3 3 0 0 1 3 3v8a3 3 0 0 1 -3 3h-5l-5 3v-3h-2a3 3 0 0 1 -3 -3v-8a3 3 0 0 1 3 -3h12z"></path>
            </svg>
            发表回复
          </div>
          <div class="reply-editor-body">
            <div id="article_details_reply" style="height: 350px;">
              <textarea id="details_article_reply_content" style="display: none;"></textarea>
            </div>
          </div>
          <div class="reply-editor-footer">
            <a href="javascript:void(0);" class="btn btn-primary" id="details_btn_article_reply">
              <svg xmlns="http://www.w3.org/2000/svg" class="icon me-1" width="20" height="20" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none">
                <path d="M10 14l11 -11"></path>
                <path d="M21 3l-6.5 18a.55 .55 0 0 1 -1 0l-3.5 -7l-7 -3.5a.55 .55 0 0 1 0 -1l18 -6.5"></path>
              </svg>
              发表回复
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- 删除确认弹窗 -->
<div class="modal modal-blur fade" id="details_delete_modal" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog modal-sm modal-dialog-centered" role="document">
    <div class="modal-content">
      <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      <div class="modal-status bg-danger"></div>
      <div class="modal-body text-center py-4">
        <svg xmlns="http://www.w3.org/2000/svg" class="icon mb-2 text-danger icon-lg" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none">
          <path d="M12 9v2m0 4v.01"></path>
          <path d="M5 19h14a2 2 0 0 0 1.84 -2.75l-7.1 -12.25a2 2 0 0 0 -3.5 0l-7.1 12.25a2 2 0 0 0 1.75 2.75"></path>
        </svg>
        <h3>确定要删除当前帖子吗?</h3>
        <div class="text-muted">点击确认该帖子将被删除.</div>
      </div>
      <div class="modal-footer">
        <div class="w-100">
          <div class="row">
            <div class="col"><a href="javascript:void(0);" class="btn w-100" data-bs-dismiss="modal">取消</a></div>
            <div class="col"><a href="javascript:void(0);" class="btn btn-danger w-100" data-bs-dismiss="modal" id="details_artile_delete">删除</a></div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>


<script>
  $(function () {
    // ===================== 初始化回复编辑区 ===================== 
    var editor = editormd("article_details_reply", {
      width: "100%",
      height: "100%",
      autoFocus: false,
      codeFold: true,
      markdown: '',
      saveHTMLToTextarea: true,
      searchReplace: true,
      watch: false,
      htmlDecode: "style,script,iframe|on*",
      emoji: true,
      taskList: true,
      tocm: true,
      tex: true,
      placeholder: '写下你的回复...',
      path: "./dist/editor.md/lib/"
    });

    // ===================== 请求帖子详情 ===================== 
    // 获取帖子ID：优先从currentArticle获取，否则从URL参数获取
    let articleId = null;
    if (typeof currentArticle !== 'undefined' && currentArticle && currentArticle.id) {
      articleId = currentArticle.id;
    } else {
      // 从URL参数获取id
      let urlParams = new URLSearchParams(window.location.search);
      articleId = urlParams.get('id');
    }
    
    if (!articleId) {
      $.toast({ heading: '错误', text: '未找到帖子信息，请从首页进入', icon: 'error' });
      return;
    }
    
    $.ajax({
      type: 'get',
      url: 'article/details?id=' + articleId,
      success: function (respData) {
        if (respData.code == 0) {
          initArticleDetails(respData.data);
        } else {
          $.toast({ heading: '警告', text: respData.message, icon: 'warning' });
        }
      },
      error: function () {
        $.toast({ heading: '错误', text: '访问出现问题,请与管理员联系.', icon: 'error' });
      }
    });

    // ===================== 初始化页面内容 ======================
    function initArticleDetails(article) {
      currentArticle = article;
      if (!article.user.avatarUrl) {
        article.user.avatarUrl = avatarUrl;
      }

      $('#article_details_author_avatar').css('background-image', 'url(' + article.user.avatarUrl + ')');
      $('#article_details_author_name').html(article.user.nickname);
      $('#details_article_id').val(article.id);
      $('#details_article_title').html(article.title);
      $('#details_article_createTime').html(article.createTime);
      $('#details_article_visitCount').html(article.visitCount);
      $('#details_article_likeCount').html(article.likeCount);
      $('#details_article_replyCount').html(article.replyCount);
      $('#details_article_content_title').html(article.title);
      editormd.markdownToHTML('details_article_content', { markdown: article.content });
      
      // 作者统计
      $('#author_article_count').html(article.visitCount || 0);
      // 获赞数暂时显示当前帖子的点赞数（如需显示总获赞需要后端支持）
      $('#author_like_count').html(article.likeCount || 0);
      
      if (article.own) {
        $('.details-is-own').show();
      }
      if (article.user.id == currentUserId) {
        $('#div_details_send_message').hide();
      } else {
        $('#btn_details_send_message').click(function () {
          // 检查是否登录
          if (!currentUserId) {
            $.toast({ heading: '提示', text: '请先登录后再发送私信', icon: 'warning' });
            return;
          }
          setMessageReceiveUserInfo(article.user.id, article.user.nickname);
          // 手动打开弹窗
          var messageModal = new bootstrap.Modal(document.getElementById('index_message_modal'));
          messageModal.show();
        });
      }
      $('#article_details_author_name').click(function () {
        profileUserId = article.userId;
        if (article.userId == currentUserId) {
          profileUserId = undefined;
        }
        $('#bit-forum-content').load('profile.html');
      });
      
      // 加载回复列表
      loadArticleDetailsReply();
      
      // 记录浏览历史
      if (currentUserId) {
        addToHistory(article);
      }
    }

    // ====================== 加载回复列表 ======================
    function loadArticleDetailsReply() {
      if (!currentArticle || !currentArticle.id) {
        return;
      }
      $.ajax({
        type: 'get',
        url: 'reply/getReplies?articleId=' + currentArticle.id,
        success: function (respData) {
          if (respData.code == 0) {
            buildArticleReply(respData.data);
          }
        }
      });
    }

    function buildArticleReply(data) {
      let replyArea = $('#details_reply_area');
      if (!data || data.length == 0) {
        replyArea.html('<div class="empty-reply">'
          + '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">'
          + '<path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>'
          + '<div>还没有回复，第一个写下回复吧</div></div>');
        return;
      }
      replyArea.html('');
      data.forEach(articleReply => {
        if (!articleReply.user.avatarUrl) {
          articleReply.user.avatarUrl = avatarUrl;
        }
        let replyHtml = '<div class="reply-item">'
          + '<div class="reply-author">'
          + '<span class="avatar reply-avatar" style="background-image: url(' + articleReply.user.avatarUrl + ')"></span>'
          + '<div class="reply-author-name a_reply_user_profile" style="cursor:pointer;">' + articleReply.user.nickname + '</div>'
          + '</div>'
          + '<div class="reply-content-area">'
          + '<div class="reply-content" id="details_article_reply_content_' + articleReply.id + '"></div>'
          + '<div class="reply-time">' + articleReply.createTime + '</div>'
          + '</div>'
          + '</div>';

        let replyItem = $(replyHtml);
        replyItem.find('.a_reply_user_profile').click(function () {
          profileUserId = articleReply.user.id;
          $('#bit-forum-content').load('profile.html');
        });
        replyArea.append(replyItem);
        editormd.markdownToHTML('details_article_reply_content_' + articleReply.id, { markdown: articleReply.content });
      });
    }

    // ====================== 处理点赞 ======================
    $('#details_btn_like_count').click(function () {
      if (!currentUserId) {
        $.toast({ heading: '提示', text: '请先登录后再点赞', icon: 'warning' });
        return;
      }
      $.ajax({
        type: 'post',
        url: 'article/thumbsUp?id=' + currentArticle.id,
        success: function (respData) {
          if (respData.code == 0) {
            currentArticle.likeCount = currentArticle.likeCount + 1;
            $('#details_article_likeCount').html(currentArticle.likeCount);
            $.toast({ heading: '成功', text: '点赞成功，已添加到收藏', icon: 'success' });
            // 添加到收藏
            addToFavorites(currentArticle);
          } else {
            $.toast({ heading: '警告', text: respData.message, icon: 'warning' });
          }
        },
        error: function () {
          $.toast({ heading: '错误', text: '访问出现问题,请与管理员联系.', icon: 'error' });
        }
      });
    });
    
    // ====================== 添加到收藏 ======================
    function addToFavorites(article) {
      if (!currentUserId) return;
      let favorites = JSON.parse(localStorage.getItem('forum_favorites_' + currentUserId) || '[]');
      // 检查是否已存在
      if (favorites.some(f => f.id == article.id)) return;
      favorites.push({
        id: article.id,
        title: article.title,
        author: article.user ? article.user.nickname : '未知',
        time: new Date().toLocaleString()
      });
      // 最多保存50条
      if (favorites.length > 50) favorites = favorites.slice(-50);
      localStorage.setItem('forum_favorites_' + currentUserId, JSON.stringify(favorites));
    }
    
    // ====================== 添加到浏览记录 ======================
    function addToHistory(article) {
      if (!currentUserId) return;
      let history = JSON.parse(localStorage.getItem('forum_history_' + currentUserId) || '[]');
      // 移除已存在的相同记录
      history = history.filter(h => h.id != article.id);
      history.push({
        id: article.id,
        title: article.title,
        author: article.user ? article.user.nickname : '未知',
        time: new Date().toLocaleString()
      });
      // 最多保存100条
      if (history.length > 100) history = history.slice(-100);
      localStorage.setItem('forum_history_' + currentUserId, JSON.stringify(history));
    }
    
    // 页面加载时记录浏览历史（移到initArticleDetails中调用）

    // ====================== 回复帖子 ======================
    $('#details_btn_article_reply').click(function () {
      if (!currentUserId) {
        $.toast({ heading: '提示', text: '请先登录后再回复帖子', icon: 'warning' });
        return;
      }
      let articleIdEl = $('#details_article_id');
      let replyContentEl = $('#details_article_reply_content');
      if (!replyContentEl.val()) {
        $.toast({ heading: '提示', text: '请输入回复内容', icon: 'warning' });
        return;
      }
      let postData = { articleId: articleIdEl.val(), content: replyContentEl.val() };
      $.ajax({
        type: 'post',
        url: 'reply/create',
        contentType: 'application/x-www-form-urlencoded',
        data: postData,
        success: function (respData) {
          if (respData.code == 0) {
            $.toast({ heading: '提示', text: '回复成功', icon: 'success' });
            currentArticle.replyCount = currentArticle.replyCount + 1;
            $('#details_article_replyCount').html(currentArticle.replyCount);
            loadArticleDetailsReply();
            // 清空编辑器内容
            editor.setMarkdown('');
          } else {
            $.toast({ heading: '提示', text: respData.message, icon: 'warning' });
          }
        },
        error: function () {
          $.toast({ heading: '错误', text: '访问出现问题,请与管理员联系.', icon: 'error' });
        }
      });
    });

    // ====================== 处理删除事件 ======================
    $('#details_artile_delete').click(function () {
      $.ajax({
        type: 'post',
        url: 'article/delete?id=' + $('#details_article_id').val(),
        success: function (respData) {
          if (respData.code == 0) {
            $.toast({ heading: '成功', text: '删除成功', icon: 'success' });
            changeNavActive($('#nav-link-title'));
          } else {
            $.toast({ heading: '警告', text: respData.message, icon: 'warning' });
          }
        },
        error: function () {
          $.toast({ heading: '错误', text: '访问出现问题,请与管理员联系.', icon: 'error' });
        }
      });
    });

    // ====================== 编辑帖子 ======================
    $('#details_artile_edit').click(function () {
      $('#bit-forum-content').load('article_edit.html');
    });

    // ====================== AI回答功能 ======================
    $('#details_btn_ai_reply').click(function () {
      if (!currentUserId) {
        $.toast({ heading: '提示', text: '请先登录后使用AI功能', icon: 'warning' });
        return;
      }
      let btn = $(this);
      btn.addClass('disabled').html('<span class="spinner-border spinner-border-sm me-1"></span>AI思考中...');
      $.ajax({
        type: 'get',
        url: 'ai/generateReply?articleId=' + currentArticle.id,
        success: function (respData) {
          btn.removeClass('disabled').html('<svg xmlns="http://www.w3.org/2000/svg" class="icon" width="20" height="20" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none"><path d="M6 4m0 2a2 2 0 0 1 2 -2h8a2 2 0 0 1 2 2v4a2 2 0 0 1 -2 2h-8a2 2 0 0 1 -2 -2z"></path><path d="M12 2v2"></path><path d="M9 12v9"></path><path d="M15 12v9"></path><path d="M5 16l4 -2"></path><path d="M15 14l4 2"></path><path d="M9 18h6"></path><path d="M10 8v.01"></path><path d="M14 8v.01"></path></svg> AI回答');
          if (respData.code == 0) {
            $('#ai_reply_area').show();
            editormd.markdownToHTML('ai_reply_content', { markdown: respData.data });
          } else {
            $.toast({ heading: '警告', text: respData.message, icon: 'warning' });
          }
        },
        error: function () {
          btn.removeClass('disabled').html('<svg xmlns="http://www.w3.org/2000/svg" class="icon" width="20" height="20" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none"><path d="M6 4m0 2a2 2 0 0 1 2 -2h8a2 2 0 0 1 2 2v4a2 2 0 0 1 -2 2h-8a2 2 0 0 1 -2 -2z"></path><path d="M12 2v2"></path><path d="M9 12v9"></path><path d="M15 12v9"></path><path d="M5 16l4 -2"></path><path d="M15 14l4 2"></path><path d="M9 18h6"></path><path d="M10 8v.01"></path><path d="M14 8v.01"></path></svg> AI回答');
          $.toast({ heading: '错误', text: 'AI服务暂时不可用', icon: 'error' });
        }
      });
    });

    // ====================== AI摘要功能 ======================
    $('#details_btn_ai_summary').click(function () {
      if (!currentUserId) {
        $.toast({ heading: '提示', text: '请先登录后使用AI功能', icon: 'warning' });
        return;
      }
      let btn = $(this);
      btn.addClass('disabled').html('<span class="spinner-border spinner-border-sm me-1"></span>生成中...');
      $.ajax({
        type: 'get',
        url: 'ai/generateSummary?articleId=' + currentArticle.id,
        success: function (respData) {
          btn.removeClass('disabled').html('<svg xmlns="http://www.w3.org/2000/svg" class="icon" width="20" height="20" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none"><path d="M14 3v4a1 1 0 0 0 1 1h4"></path><path d="M17 21h-10a2 2 0 0 1 -2 -2v-14a2 2 0 0 1 2 -2h7l5 5v11a2 2 0 0 1 -2 2z"></path><path d="M9 9l1 0"></path><path d="M9 13l6 0"></path><path d="M9 17l6 0"></path></svg> AI摘要');
          if (respData.code == 0) {
            $('#ai_summary_area').show();
            editormd.markdownToHTML('ai_summary_content', { markdown: respData.data });
          } else {
            $.toast({ heading: '警告', text: respData.message, icon: 'warning' });
          }
        },
        error: function () {
          btn.removeClass('disabled').html('<svg xmlns="http://www.w3.org/2000/svg" class="icon" width="20" height="20" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none"><path d="M14 3v4a1 1 0 0 0 1 1h4"></path><path d="M17 21h-10a2 2 0 0 1 -2 -2v-14a2 2 0 0 1 2 -2h7l5 5v11a2 2 0 0 1 -2 2z"></path><path d="M9 9l1 0"></path><path d="M9 13l6 0"></path><path d="M9 17l6 0"></path></svg> AI摘要');
          $.toast({ heading: '错误', text: 'AI服务暂时不可用', icon: 'error' });
        }
      });
    });
  });
</script>
