<!-- 个人中心 - 优化版 -->
<style>
  /* 个人中心头部 */
  .settings-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    padding: 25px 0 50px;
    color: white;
    position: relative;
  }
  .settings-header::after {
    content: '';
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    height: 25px;
    background: #f5f7fb;
    border-radius: 25px 25px 0 0;
  }
  .settings-header h2 {
    font-weight: 600;
    font-size: 1.2rem;
    margin: 0;
  }
  
  /* 主内容区 */
  .settings-content {
    background: #f5f7fb;
    padding: 0 0 30px;
    min-height: calc(100vh - 200px);
  }
  
  /* 用户卡片 */
  .user-profile-card {
    background: white;
    border-radius: 12px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.08);
    padding: 20px;
    margin-top: -35px;
    position: relative;
    z-index: 10;
    text-align: center;
  }
  .avatar-upload-wrapper {
    position: relative;
    display: inline-block;
    margin-bottom: 12px;
  }
  .settings-avatar {
    width: 70px;
    height: 70px;
    border-radius: 50%;
    border: 3px solid white;
    box-shadow: 0 3px 12px rgba(0,0,0,0.12);
    cursor: pointer;
    transition: all 0.3s;
  }
  .settings-avatar:hover {
    transform: scale(1.05);
    box-shadow: 0 5px 20px rgba(102,126,234,0.25);
  }
  .avatar-upload-btn {
    position: absolute;
    bottom: 2px;
    right: 2px;
    width: 24px;
    height: 24px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    box-shadow: 0 2px 8px rgba(102,126,234,0.4);
    transition: all 0.3s;
  }
  .avatar-upload-btn:hover {
    transform: scale(1.1);
  }
  .avatar-upload-btn svg {
    width: 12px;
    height: 12px;
    color: white;
  }
  .user-name {
    font-size: 1.1rem;
    font-weight: 600;
    color: #333;
    margin-bottom: 4px;
  }
  .user-role {
    display: inline-block;
    padding: 3px 10px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 12px;
    font-size: 0.7rem;
  }
  
  /* 设置卡片 */
  .settings-card {
    background: white;
    border-radius: 12px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.06);
    overflow: hidden;
    margin-bottom: 15px;
  }
  .settings-card-header {
    padding: 12px 16px;
    border-bottom: 1px solid #f0f0f0;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .settings-card-header svg {
    width: 16px;
    height: 16px;
    color: #667eea;
  }
  .settings-card-header h3 {
    margin: 0;
    font-size: 0.9rem;
    font-weight: 600;
    color: #333;
  }
  .settings-card-body {
    padding: 16px;
  }
  
  /* 表单项 */
  .form-item {
    margin-bottom: 14px;
  }
  .form-item:last-child {
    margin-bottom: 0;
  }
  .form-item-label {
    font-size: 0.8rem;
    font-weight: 500;
    color: #555;
    margin-bottom: 6px;
    display: flex;
    align-items: center;
    gap: 6px;
  }
  .form-item-label svg {
    width: 14px;
    height: 14px;
    color: #999;
  }
  .form-row {
    display: flex;
    gap: 10px;
    align-items: flex-start;
  }
  .form-row .form-control {
    flex: 1;
    border-radius: 8px;
    border: 1px solid #e0e0e0;
    padding: 8px 12px;
    font-size: 0.85rem;
    transition: all 0.3s;
  }
  .form-row .form-control:focus {
    border-color: #667eea;
    box-shadow: 0 0 0 2px rgba(102,126,234,0.1);
  }
  .btn-modify {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 8px;
    font-weight: 500;
    font-size: 0.8rem;
    transition: all 0.3s;
    white-space: nowrap;
  }
  .btn-modify:hover {
    transform: translateY(-1px);
    box-shadow: 0 3px 12px rgba(102,126,234,0.35);
    color: white;
  }
  
  /* 密码表单 */
  .password-form .form-item {
    margin-bottom: 12px;
  }
  .password-input-wrapper {
    position: relative;
  }
  .password-input-wrapper .form-control {
    padding-right: 36px;
    border-radius: 8px;
    border: 1px solid #e0e0e0;
    padding: 8px 12px;
    font-size: 0.85rem;
  }
  .password-input-wrapper .form-control:focus {
    border-color: #667eea;
    box-shadow: 0 0 0 2px rgba(102,126,234,0.1);
  }
  .password-toggle {
    position: absolute;
    right: 10px;
    top: 50%;
    transform: translateY(-50%);
    cursor: pointer;
    color: #999;
    transition: color 0.3s;
  }
  .password-toggle:hover {
    color: #667eea;
  }
  .password-toggle svg {
    width: 16px;
    height: 16px;
  }
  .btn-submit-password {
    background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 8px;
    font-weight: 500;
    font-size: 0.85rem;
    width: 100%;
    margin-top: 8px;
    transition: all 0.3s;
  }
  .btn-submit-password:hover {
    transform: translateY(-1px);
    box-shadow: 0 3px 12px rgba(245,87,108,0.35);
    color: white;
  }
  .btn-submit-password svg {
    width: 14px;
    height: 14px;
  }
  
  /* 个人简介 */
  .remark-textarea {
    border-radius: 8px;
    border: 1px solid #e0e0e0;
    padding: 10px 12px;
    font-size: 0.85rem;
    resize: none;
    transition: all 0.3s;
    width: 100%;
  }
  .remark-textarea:focus {
    border-color: #667eea;
    box-shadow: 0 0 0 2px rgba(102,126,234,0.1);
  }
  
  /* 侧边导航 */
  .settings-nav {
    background: white;
    border-radius: 12px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.06);
    overflow: hidden;
  }
  .settings-nav-item {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 10px 14px;
    color: #666;
    text-decoration: none;
    font-size: 0.85rem;
    transition: all 0.3s;
    border-left: 2px solid transparent;
  }
  .settings-nav-item:hover {
    background: #f8f9ff;
    color: #667eea;
  }
  .settings-nav-item.active {
    background: linear-gradient(to right, #f0f3ff, #ffffff);
    color: #667eea;
    border-left-color: #667eea;
    font-weight: 500;
  }
  .settings-nav-item svg {
    width: 16px;
    height: 16px;
  }
  
  /* 收藏和浏览记录列表样式 */
  .record-item {
    display: flex;
    align-items: center;
    padding: 12px 16px;
    border-bottom: 1px solid #f5f5f5;
    transition: all 0.2s;
  }
  .record-item:last-child {
    border-bottom: none;
  }
  .record-item:hover {
    background: #fafbff;
  }
  .record-content {
    flex: 1;
    min-width: 0;
  }
  .record-title {
    display: block;
    font-size: 0.85rem;
    color: #333;
    text-decoration: none;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    transition: color 0.2s;
  }
  .record-title:hover {
    color: #667eea;
  }
  .record-meta {
    display: flex;
    gap: 10px;
    margin-top: 4px;
    font-size: 0.75rem;
    color: #999;
  }
  .record-author {
    color: #667eea;
  }
  .record-remove {
    color: #ccc;
    padding: 4px;
    transition: color 0.2s;
  }
  .record-remove:hover {
    color: #e53935;
  }
</style>

<input type="hidden" id="settings_user_id">
<input type="file" style="display: none;" id="settings_input_chooiceAvatar" accept="image/*">

<!-- 头部背景 -->
<div class="settings-header">
  <div class="container-xl">
    <h2 class="text-center" style="opacity: 0.95;">个人中心</h2>
  </div>
</div>

<!-- 主内容区 -->
<div class="settings-content">
  <div class="container-xl">
    <div class="row g-4">
      <!-- 左侧用户卡片和导航 -->
      <div class="col-lg-4">
        <!-- 用户信息卡片 -->
        <div class="user-profile-card">
          <div class="avatar-upload-wrapper">
            <span id="settings_avatar" class="avatar settings-avatar" style="background-image: url(./image/avatar01.jpeg)" onclick="openFileDialog()"></span>
            <div class="avatar-upload-btn" onclick="openFileDialog()">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path>
                <circle cx="12" cy="13" r="4"></circle>
              </svg>
            </div>
          </div>
          <div class="user-name" id="settings_nickname">用户</div>
          <div class="user-role" id="settings_role">普通用户</div>
        </div>
        
        <!-- 导航菜单 -->
        <div class="settings-nav mt-4">
          <a href="javascript:void(0);" class="settings-nav-item active" onclick="scrollToSection('section_basic', this)">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
              <circle cx="12" cy="7" r="4"></circle>
            </svg>
            基本信息
          </a>
          <a href="javascript:void(0);" class="settings-nav-item" onclick="scrollToSection('section_security', this)">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
              <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
            </svg>
            安全设置
          </a>
          <a href="javascript:void(0);" class="settings-nav-item" onclick="scrollToSection('section_remark', this)">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
              <polyline points="14 2 14 8 20 8"></polyline>
              <line x1="16" y1="13" x2="8" y2="13"></line>
              <line x1="16" y1="17" x2="8" y2="17"></line>
            </svg>
            个人简介
          </a>
          <a href="javascript:void(0);" class="settings-nav-item" onclick="scrollToSection('section_favorites', this)">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
            </svg>
            我的收藏
          </a>
          <a href="javascript:void(0);" class="settings-nav-item" onclick="scrollToSection('section_history', this)">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10"></circle>
              <polyline points="12 6 12 12 16 14"></polyline>
            </svg>
            浏览记录
          </a>
        </div>
      </div>
      
      <!-- 右侧设置表单 -->
      <div class="col-lg-8">
        <!-- 基本信息卡片 -->
        <div class="settings-card" id="section_basic">
          <div class="settings-card-header">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
              <circle cx="12" cy="7" r="4"></circle>
            </svg>
            <h3>基本信息</h3>
          </div>
          <div class="settings-card-body">
            <div class="form-item">
              <div class="form-item-label">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                  <circle cx="12" cy="7" r="4"></circle>
                </svg>
                昵称
              </div>
              <div class="form-row">
                <input id="setting_input_nickname" type="text" class="form-control" placeholder="请输入昵称">
                <a href="javascript:void(0);" class="btn btn-modify" id="setting_submit_nickname">修改</a>
              </div>
            </div>
            <div class="form-item">
              <div class="form-item-label">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path>
                  <polyline points="22,6 12,13 2,6"></polyline>
                </svg>
                邮箱地址
              </div>
              <div class="form-row">
                <input id="setting_input_email" type="email" class="form-control" placeholder="请输入邮箱">
                <a href="javascript:void(0);" class="btn btn-modify" id="setting_submit_email">修改</a>
              </div>
            </div>
            <div class="form-item">
              <div class="form-item-label">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path>
                </svg>
                电话号码
              </div>
              <div class="form-row">
                <input id="setting_input_phoneNum" type="tel" class="form-control" placeholder="请输入电话号码">
                <a href="javascript:void(0);" class="btn btn-modify" id="setting_submit_phoneNum">修改</a>
              </div>
            </div>
          </div>
        </div>

        <!-- 安全设置卡片 -->
        <div class="settings-card" id="section_security">
          <div class="settings-card-header">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
              <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
            </svg>
            <h3>修改密码</h3>
          </div>
          <div class="settings-card-body">
            <div class="password-form">
              <div class="form-item">
                <div class="form-item-label">原密码</div>
                <div class="password-input-wrapper">
                  <input id="settings_input_oldPassword" type="password" class="form-control" placeholder="请输入原密码" autocomplete="off">
                  <span class="password-toggle" onclick="togglePassword(this)">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                      <circle cx="12" cy="12" r="3"></circle>
                    </svg>
                  </span>
                </div>
              </div>
              <div class="form-item">
                <div class="form-item-label">新密码</div>
                <div class="password-input-wrapper">
                  <input id="settings_input_newPassword" type="password" class="form-control" placeholder="请输入新密码" autocomplete="off">
                  <span class="password-toggle" onclick="togglePassword(this)">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                      <circle cx="12" cy="12" r="3"></circle>
                    </svg>
                  </span>
                </div>
              </div>
              <div class="form-item">
                <div class="form-item-label">确认密码</div>
                <div class="password-input-wrapper">
                  <input id="settings_input_passwordRepeat" type="password" class="form-control" placeholder="请再次输入新密码" autocomplete="off">
                  <span class="password-toggle" onclick="togglePassword(this)">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                      <circle cx="12" cy="12" r="3"></circle>
                    </svg>
                  </span>
                </div>
              </div>
              <button type="button" class="btn btn-submit-password" id="settings_submit_password">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 8px;">
                  <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                  <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
                </svg>
                确认修改密码
              </button>
            </div>
          </div>
        </div>
        
        <!-- 个人简介卡片 -->
        <div class="settings-card" id="section_remark">
          <div class="settings-card-header">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
              <polyline points="14 2 14 8 20 8"></polyline>
              <line x1="16" y1="13" x2="8" y2="13"></line>
              <line x1="16" y1="17" x2="8" y2="17"></line>
            </svg>
            <h3>个人简介</h3>
          </div>
          <div class="settings-card-body">
            <div class="form-item">
              <textarea id="settings_textarea_remark" class="remark-textarea" rows="5" placeholder="写点自我介绍，让大家更了解你..."></textarea>
            </div>
            <div style="text-align: right; margin-top: 15px;">
              <a href="javascript:void(0);" class="btn btn-modify" id="settings_submit_remark">保存简介</a>
            </div>
          </div>
        </div>
        
        <!-- 我的收藏卡片 -->
        <div class="settings-card" id="section_favorites">
          <div class="settings-card-header">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
            </svg>
            <h3>我的收藏</h3>
            <span class="badge bg-primary ms-auto" id="favorites_count">0</span>
          </div>
          <div class="settings-card-body" style="padding: 0;">
            <div id="favorites_list">
              <!-- 收藏列表动态加载 -->
            </div>
            <div id="favorites_empty" class="text-center py-4 text-muted" style="display: none;">
              <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="opacity: 0.4;">
                <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
              </svg>
              <div style="margin-top: 8px; font-size: 0.85rem;">暂无收藏</div>
              <div style="font-size: 0.75rem; color: #aaa;">点赞帖子后会自动添加到收藏</div>
            </div>
          </div>
        </div>
        
        <!-- 浏览记录卡片 -->
        <div class="settings-card" id="section_history">
          <div class="settings-card-header">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10"></circle>
              <polyline points="12 6 12 12 16 14"></polyline>
            </svg>
            <h3>浏览记录</h3>
            <span class="badge bg-secondary ms-auto" id="history_count">0</span>
            <a href="javascript:void(0);" class="btn btn-sm btn-outline-danger ms-2" id="btn_clear_history" style="font-size: 0.7rem; padding: 2px 8px;">清空</a>
          </div>
          <div class="settings-card-body" style="padding: 0;">
            <div id="history_list">
              <!-- 浏览记录动态加载 -->
            </div>
            <div id="history_empty" class="text-center py-4 text-muted" style="display: none;">
              <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="opacity: 0.4;">
                <circle cx="12" cy="12" r="10"></circle>
                <polyline points="12 6 12 12 16 14"></polyline>
              </svg>
              <div style="margin-top: 8px; font-size: 0.85rem;">暂无浏览记录</div>
              <div style="font-size: 0.75rem; color: #aaa;">浏览帖子后会自动记录</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  $(function() {
    // 获取用户详情，初始化页面内容
    $.ajax({
      type: 'get',
      url: 'user/info',
      success: function (respData){
        if(respData.code == 0){
          initUserInfo(respData.data);
        }else{
          $.toast({
            heading: '警告',
            text: respData.message,
            icon: 'warning'
          });
        }
      },
      error: function () {
        $.toast({
          heading: '错误',
          text: '访问出现问题,请与管理员联系.',
          icon: 'error'
        });
      }
    });
  });

  // 设置用户信息
  function initUserInfo(user) {
    if (!user.avatarUrl) {
      user.avatarUrl = avatarUrl;
    }
    $('#settings_user_id').val(user.id);
    $('#settings_nickname').text(user.nickname);
    $('#settings_avatar').css('background-image', 'url(' + user.avatarUrl + ')');
    $('#setting_input_nickname').val(user.nickname);
    $('#setting_input_email').val(user.email);
    $('#setting_input_phoneNum').val(user.phoneNum);
    $('#settings_textarea_remark').val(user.remark);
    
    // 设置角色
    if (user.isAdmin == 1) {
      $('#settings_role').text('管理员');
    } else {
      $('#settings_role').text('普通用户');
    }
  }

  // 封装ajax请求
  function changeUserInfo(userInfo, type) {
    if (!userInfo) {
      $.toast({
        heading: '提示',
        text: '请检查要修改的内容是否正确',
        icon: 'info'
      });
      return;
    }

    let userURL = type == 2 ? 'user/modifyPwd' : 'user/modifyInfo';

    $.ajax({
      type: 'post',
      url: userURL,
      contentType: 'application/x-www-form-urlencoded',
      data: userInfo,
      success: function (respData){
        if(respData.code == 0){
          let user = respData.data;
          if(user && user.nickname){
            $('#settings_nickname').text(user.nickname);
            $('#index_nav_nickname').html(user.nickname);
          }
          if(type == 2){
            $.toast({
              heading: '成功',
              text: '密码修改成功，即将跳转登录页',
              icon: 'success'
            });
            setTimeout(function() {
              location.assign('sign-in.html');
            }, 1500);
            return;
          }
          $.toast({
            heading: '成功',
            text: respData.message,
            icon: 'success'
          });
        }else{
          $.toast({
            heading: '警告',
            text: respData.message,
            icon: 'warning'
          });
        }
      },
      error: function () {
        $.toast({
          heading: '错误',
          text: '访问出现问题,请与管理员联系.',
          icon: 'error'
        });
      }
    });
  }

  // 打开文件选择对话框
  function openFileDialog() {
    $('#settings_input_chooiceAvatar').click();
  }

  // 滚动到指定区域
  function scrollToSection(sectionId, navEl) {
    // 更新导航激活状态
    $('.settings-nav-item').removeClass('active');
    $(navEl).addClass('active');
    
    // 滚动到对应区域
    const target = document.getElementById(sectionId);
    if (target) {
      target.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
  }

  // 切换密码显示/隐藏
  function togglePassword(el) {
    const input = $(el).siblings('input');
    if (input.attr('type') === 'password') {
      input.attr('type', 'text');
    } else {
      input.attr('type', 'password');
    }
  }

  // 修改昵称
  $('#setting_submit_nickname').click(function(){
    let nicknameEl = $('#setting_input_nickname');
    if(!nicknameEl.val()) {
      nicknameEl.focus();
      return false;
    }
    changeUserInfo({ nickname: nicknameEl.val() });
  });

  // 修改邮箱
  $('#setting_submit_email').click(function(){
    let emailEl = $('#setting_input_email');
    if(!emailEl.val()) {
      emailEl.focus();
      return false;
    }
    changeUserInfo({ email: emailEl.val() });
  });

  // 修改电话
  $('#setting_submit_phoneNum').click(function(){
    let phoneNumEl = $('#setting_input_phoneNum');
    if(!phoneNumEl.val()) {
      phoneNumEl.focus();
      return false;
    }
    changeUserInfo({ phoneNum: phoneNumEl.val() });
  });

  // 修改个人简介
  $('#settings_submit_remark').click(function(){
    let remarkEl = $('#settings_textarea_remark');
    if(!remarkEl.val()) {
      remarkEl.focus();
      return false;
    }
    changeUserInfo({ remark: remarkEl.val() });
  });

  // 修改密码
  $('#settings_submit_password').click(function() {
    let oldPasswordEl = $('#settings_input_oldPassword');
    let newPasswordEl = $('#settings_input_newPassword');
    let passwordRepeatEl = $('#settings_input_passwordRepeat');
    
    if(!oldPasswordEl.val()) {
      oldPasswordEl.focus();
      return false;
    }
    if(!newPasswordEl.val()) {
      newPasswordEl.focus();
      return false;
    }
    if(!passwordRepeatEl.val()) {
      passwordRepeatEl.focus();
      return false;
    }
    if (newPasswordEl.val() != passwordRepeatEl.val()) {
      $.toast({
        heading: '提示',
        text: '两次输入的密码不相同',
        icon: 'warning'
      });
      passwordRepeatEl.focus();
      return false;
    }

    changeUserInfo({
      id: $('#settings_user_id').val(),
      oldPassword: oldPasswordEl.val(),
      newPassword: newPasswordEl.val(),
      passwordRepeat: passwordRepeatEl.val()
    }, 2);
    
    oldPasswordEl.val('');
    newPasswordEl.val('');
    passwordRepeatEl.val('');
  });

  // 头像上传
  $('#settings_input_chooiceAvatar').change(function() {
    let file = this.files[0];
    if (!file) return;
    
    if (!file.type.startsWith('image/')) {
      $.toast({
        heading: '警告',
        text: '请选择图片文件',
        icon: 'warning'
      });
      return;
    }
    
    if (file.size > 2 * 1024 * 1024) {
      $.toast({
        heading: '警告',
        text: '图片大小不能超过2MB',
        icon: 'warning'
      });
      return;
    }
    
    let formData = new FormData();
    formData.append('file', file);
    
    $.ajax({
      type: 'post',
      url: 'user/uploadAvatar',
      data: formData,
      processData: false,
      contentType: false,
      success: function(respData) {
        if (respData.code == 0) {
          $.toast({
            heading: '成功',
            text: '头像修改成功，即将刷新页面',
            icon: 'success'
          });
          setTimeout(function() {
            location.reload();
          }, 1000);
        } else {
          $.toast({
            heading: '警告',
            text: respData.message,
            icon: 'warning'
          });
        }
      },
      error: function() {
        $.toast({
          heading: '错误',
          text: '上传失败,请与管理员联系.',
          icon: 'error'
        });
      }
    });
  });

  // ==================== 我的收藏功能 ====================
  function loadFavorites() {
    let favorites = JSON.parse(localStorage.getItem('forum_favorites_' + currentUserId) || '[]');
    $('#favorites_count').text(favorites.length);
    
    if (favorites.length === 0) {
      $('#favorites_list').hide();
      $('#favorites_empty').show();
      return;
    }
    
    $('#favorites_empty').hide();
    $('#favorites_list').show().html('');
    
    // 倒序显示（最新的在前面）
    favorites.reverse().forEach(function(item) {
      let itemHtml = '<div class="record-item" data-id="' + item.id + '">'
        + '<div class="record-content">'
        + '<a href="javascript:void(0);" class="record-title">' + item.title + '</a>'
        + '<div class="record-meta">'
        + '<span class="record-author">' + (item.author || '未知') + '</span>'
        + '<span class="record-time">' + (item.time || '') + '</span>'
        + '</div>'
        + '</div>'
        + '<a href="javascript:void(0);" class="record-remove" title="取消收藏">'
        + '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>'
        + '</a>'
        + '</div>';
      
      let $item = $(itemHtml);
      
      // 点击标题跳转到帖子详情
      $item.find('.record-title').click(function() {
        goToArticle(item.id);
      });
      
      // 取消收藏
      $item.find('.record-remove').click(function() {
        removeFavorite(item.id);
      });
      
      $('#favorites_list').append($item);
    });
  }
  
  function removeFavorite(articleId) {
    let favorites = JSON.parse(localStorage.getItem('forum_favorites_' + currentUserId) || '[]');
    favorites = favorites.filter(f => f.id != articleId);
    localStorage.setItem('forum_favorites_' + currentUserId, JSON.stringify(favorites));
    loadFavorites();
    $.toast({ heading: '提示', text: '已取消收藏', icon: 'info' });
  }

  // ==================== 浏览记录功能 ====================
  function loadHistory() {
    let history = JSON.parse(localStorage.getItem('forum_history_' + currentUserId) || '[]');
    $('#history_count').text(history.length);
    
    if (history.length === 0) {
      $('#history_list').hide();
      $('#history_empty').show();
      return;
    }
    
    $('#history_empty').hide();
    $('#history_list').show().html('');
    
    // 倒序显示（最新的在前面）
    history.reverse().forEach(function(item) {
      let itemHtml = '<div class="record-item" data-id="' + item.id + '">'
        + '<div class="record-content">'
        + '<a href="javascript:void(0);" class="record-title">' + item.title + '</a>'
        + '<div class="record-meta">'
        + '<span class="record-author">' + (item.author || '未知') + '</span>'
        + '<span class="record-time">' + (item.time || '') + '</span>'
        + '</div>'
        + '</div>'
        + '<a href="javascript:void(0);" class="record-remove" title="删除记录">'
        + '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>'
        + '</a>'
        + '</div>';
      
      let $item = $(itemHtml);
      
      // 点击标题跳转到帖子详情
      $item.find('.record-title').click(function() {
        goToArticle(item.id);
      });
      
      // 删除单条记录
      $item.find('.record-remove').click(function() {
        removeHistory(item.id);
      });
      
      $('#history_list').append($item);
    });
  }
  
  function removeHistory(articleId) {
    let history = JSON.parse(localStorage.getItem('forum_history_' + currentUserId) || '[]');
    history = history.filter(h => h.id != articleId);
    localStorage.setItem('forum_history_' + currentUserId, JSON.stringify(history));
    loadHistory();
  }
  
  // 清空浏览记录
  $('#btn_clear_history').click(function() {
    if (!confirm('确定要清空所有浏览记录吗？')) return;
    localStorage.setItem('forum_history_' + currentUserId, '[]');
    loadHistory();
    $.toast({ heading: '提示', text: '浏览记录已清空', icon: 'info' });
  });
  
  // 跳转到帖子详情
  function goToArticle(articleId) {
    // 通过AJAX获取帖子信息
    $.ajax({
      type: 'get',
      url: 'article/details?id=' + articleId,
      success: function(respData) {
        if (respData.code == 0) {
          currentArticle = respData.data;
          removeNavActive();
          $('#bit-forum-content').load('details.html', function() {
            // 加载完成后滚动到页面顶部
            $('html, body').animate({ scrollTop: 0 }, 300);
          });
        } else {
          $.toast({ heading: '警告', text: '帖子不存在或已删除', icon: 'warning' });
        }
      },
      error: function() {
        $.toast({ heading: '错误', text: '获取帖子失败', icon: 'error' });
      }
    });
  }
  
  // 页面加载时初始化收藏和浏览记录
  setTimeout(function() {
    if (currentUserId) {
      loadFavorites();
      loadHistory();
    }
  }, 500);
</script>
